# UI Foundation Implementation PRP

## Purpose

Establish a production-ready, accessible, themeable UI foundation (tokens, primitives, patterns, docs, tests) for a Next.js App Router app using Tailwind CSS, Radix UI primitives, and shadcn copy-in component patterns. You can use PRPs/13.prp_design_system_Execution Plan.md as an execution plan. 

## Core Principles

- **Context is King**: Include all docs, commands, and file scaffolds needed to build and validate the UI foundation.
- **Validation Loops**: Ship Storybook + tests (axe, unit, visual) and CI checks at each phase.
- **Information Dense**: Use codebase keywords (Next.js App Router, RSC, "use client", tokens, CVA, Radix).
- **Progressive Success**: Start with minimal viable package → validate → expand systematically.
- **Global rules**: Follow coding preferences (simple, no duplication, env-aware, files ≤300 LOC, no stubs in dev/prod).
- **Stop at each visual review checkpoint for user review**
- **Mark the task is completed after you complete the task in the PRPs/13.prp_design_system_Execution Plan.md**

## Goal

Build a reusable, versioned design system package (`packages/ui`) that provides:

- **Design tokens** with semantic layers (CSS variables; light/dark) mapped to Tailwind
- **Utilities**: `cn()` + CVA variants; Tailwind preset with z-index scale
- **Primitives** (Radix-based, shadcn-style): Button, Input, Label, Select, Dialog, Drawer/Sheet, Tooltip, Toast, Tabs, Badge, Card, Skeleton, Separator
- **Composition patterns**: ButtonGroup, FormRow, PageHeader, Prose (PortableText/MDX typography), PaywallCTA shell
- **Docs & Tests**: Storybook with a11y addon, unit tests (Vitest), visual baselines (Playwright), bundle size monitoring
- **RSC-friendly exports** with minimal "use client" scopes
- **Developer experience**: Hot reload, concurrent dev scripts, automated documentation

## Why

- **Business value**: 3x faster feature delivery with consistent, accessible UI; reduced QA cycles
- **Integration**: Plugs seamlessly into Next.js (RSC), Sanity PortableText, Mux player chrome, Stripe paywall UI
- **Solves**: A11y violations, CSS drift, component inconsistency, theming overhead, dark mode flash
- **Scale**: Supports A/B testing, white-labeling, and multi-brand scenarios via token architecture

## What

Provide a tree-shakeable UI package consumed by `apps/web`. Enforce accessibility, size budgets (<50kb gzipped for core), and testable states (loading/empty/error/success) for all components.

## Success Criteria

- [ ] **Phase 0 complete**: Button renders in app with full build pipeline working
- [ ] `packages/ui` builds and tree-shakes; imports work in `apps/web`
- [ ] Tokens support light/dark with no flash; semantic layer enables rebrand in <1hr
- [ ] All primitives pass axe in Storybook; keyboard navigation WCAG AA compliant
- [ ] Visual baselines created; regression detection catches unintended changes
- [ ] Core bundle <50kb gzipped; no global "use client"; server components by default
- [ ] CI green: lint, typecheck, unit (>80% coverage), Storybook build, visual snapshots
- [ ] Developer can add new variant in <5 minutes using existing patterns

## All Needed Context

### Documentation & References

#### Core Technologies
- **Tailwind CSS** - https://tailwindcss.com/docs
  - Sections: [theme-config, dark-mode, optimizing-for-production]
  - Critical: HSL color format for opacity utilities, JIT mode configuration
- **Radix UI** - https://www.radix-ui.com/primitives/docs
  - Sections: [Dialog, Popover, Select, Tabs, Tooltip, Toast]
  - Critical: Portal rendering, focus restoration, aria-attributes, data-state
- **shadcn/ui** - https://ui.shadcn.com/docs
  - Sections: [installation, theming, cli]
  - Critical: Copy-in philosophy, CVA patterns, tailwind-merge setup
- **Next.js** - https://nextjs.org/docs/app/building-your-application/rendering
  - Sections: [server-components, client-components]
  - Critical: Component boundaries, "use client" directive scope

#### Testing & Quality
- **Storybook** - https://storybook.js.org/docs/react/writing-tests/accessibility-testing
  - Critical: @storybook/addon-a11y configuration, automated checks
- **Playwright** - https://playwright.dev/docs/test-snapshots
  - Critical: Visual regression setup, CI integration

#### Performance
- **Bundle Analysis** - https://bundlephobia.com/
  - Why: Check dependencies bundle impact before adding
- **PRD** (current project)
  - Why: Environment strategy, CI/CD expectations, deployment targets

### Current Codebase Tree

```
.
├── apps/
│   └── web/                    # Next.js App Router application
│       ├── app/
│       │   ├── layout.tsx
│       │   ├── page.tsx
│       │   └── globals.css
│       ├── tailwind.config.ts
│       ├── postcss.config.js
│       ├── next.config.js
│       └── package.json
├── packages/                   # Monorepo packages directory
├── package.json               # Root package.json
├── pnpm-workspace.yaml       # PNPM workspace config
└── turbo.json                # Turborepo config
```

### Desired Codebase Tree

```
.
├── apps/
│   └── web/
│       ├── app/
│       │   ├── layout.tsx                 # Imports theme provider
│       │   └── globals.css                # Imports token CSS
│       ├── tailwind.config.ts            # Extends UI preset
│       └── components/
│           └── theme-provider.tsx        # Theme switching logic
├── packages/
│   └── ui/
│       ├── src/
│       │   ├── tokens/
│       │   │   ├── base.css             # CSS reset, box-sizing
│       │   │   ├── colors.css           # Base color scale
│       │   │   ├── semantic.css         # Semantic token mapping
│       │   │   └── index.css            # Combines all tokens
│       │   ├── utils/
│       │   │   ├── cn.ts                # clsx + tailwind-merge
│       │   │   ├── cva.ts               # Re-export with defaults
│       │   │   └── a11y.ts              # Keyboard nav helpers
│       │   ├── primitives/
│       │   │   ├── button/
│       │   │   │   ├── button.tsx
│       │   │   │   ├── button.stories.tsx
│       │   │   │   └── button.test.tsx
│       │   │   ├── input/
│       │   │   ├── dialog/
│       │   │   └── [other primitives...]
│       │   ├── compositions/
│       │   │   ├── button-group/
│       │   │   ├── form-row/
│       │   │   └── [other compositions...]
│       │   ├── patterns/
│       │   │   ├── page-header/
│       │   │   ├── prose/
│       │   │   └── paywall-cta/
│       │   ├── hooks/                   # Shared hooks
│       │   │   ├── use-toast.ts
│       │   │   └── use-theme.ts
│       │   ├── index.ts                 # Public API exports
│       │   └── tailwind-preset.ts       # Tailwind configuration
│       ├── .storybook/
│       │   ├── main.ts
│       │   ├── preview.tsx              # Global decorators
│       │   └── preview-head.html        # Font loading
│       ├── test/
│       │   ├── setup.ts                 # Test environment setup
│       │   └── utils.tsx                # Test helpers
│       ├── package.json
│       ├── tsconfig.json
│       ├── vitest.config.ts
│       └── README.md                    # Component documentation
├── .github/
│   └── workflows/
│       ├── ci.yml                      # Main CI pipeline
│       └── size-check.yml              # Bundle size monitoring
└── scripts/
    └── check-component-size.js         # Enforce 300 LOC limit
```

### Known Gotchas & Library Quirks

```typescript
// CRITICAL: Next.js App Router RSC boundaries
// Components are server by default; only add "use client" for:
// - useState, useEffect, useContext
// - onClick, onChange handlers
// - Browser APIs (window, document)
// - Radix primitives that manage state

// CRITICAL: Radix Portal z-index management
// Define scale early to prevent conflicts:
const Z_INDEX = {
  dropdown: 50,
  overlay: 100,
  modal: 200,
  notification: 300,
  tooltip: 400
} as const

// CRITICAL: Tailwind + CSS variables
// Must use HSL format without hsl() wrapper:
// ✅ --primary: 217 91% 60%
// ❌ --primary: hsl(217, 91%, 60%)
// Usage: bg-primary/50 (for opacity support)

// CRITICAL: shadcn is not a dependency
// Files are copied and customized; maintain <300 LOC per file
// Use CVA for variants before creating new components

// CRITICAL: Dark mode flash prevention
// Add blocking script to layout.tsx before any components:
<script dangerouslySetInnerHTML={{
  __html: `(function(){try{const t=localStorage.getItem('theme')||'light';  document.documentElement.dataset.theme=t;}catch{}})()`
}} />

// CRITICAL: TypeScript monorepo setup
// Use project references for faster builds:
// packages/ui/tsconfig.json needs:
{
  "references": [{ "path": "../../apps/web" }],
  "composite": true
}

// CRITICAL: Storybook with RSC
// Mock Next.js specific imports:
// .storybook/main.ts needs webpack alias for next/image, next/link

// CRITICAL: Bundle size
// Check before adding any dependency:
// - Every 1kb matters for initial load
// - Prefer native APIs over libraries where possible
// - Use dynamic imports for heavy components
```

## Implementation Blueprint

### Data Models and Structure

```typescript
// Token Architecture (3 layers)
// Layer 1: Base tokens (raw values)
interface BaseTokens {
  colors: {
    slate: { 50: string; 100: string; /* ... */ 900: string };
    blue: { 50: string; 100: string; /* ... */ 900: string };
    // ... other color scales
  };
  spacing: { 0: '0'; 1: '0.25rem'; /* ... */ };
  radii: { none: '0'; sm: '0.125rem'; /* ... */ };
}

// Layer 2: Semantic tokens (meaning)
interface SemanticTokens {
  colors: {
    background: string;      // Base background
    foreground: string;      // Base text
    primary: string;         // Brand color
    secondary: string;       // Secondary brand
    muted: string;          // Subdued elements
    accent: string;         // Highlights
    destructive: string;    // Errors/danger
    success: string;        // Success states
  };
}

// Layer 3: Component tokens (specific usage)
interface ComponentTokens {
  button: {
    primary: { bg: string; text: string; hover: string };
    secondary: { bg: string; text: string; hover: string };
  };
  input: {
    border: string;
    focusRing: string;
    placeholder: string;
  };
}

// Theme type combining all layers
interface Theme {
  base: BaseTokens;
  semantic: SemanticTokens;
  components: ComponentTokens;
}

// CVA Variant System
type ButtonVariants = {
  variant: 'default' | 'secondary' | 'outline' | 'ghost' | 'destructive';
  size: 'sm' | 'md' | 'lg' | 'icon';
  state?: 'loading' | 'disabled';
}

// Composition Pattern Types
interface CompositionProps {
  children: React.ReactNode;
  className?: string;
  asChild?: boolean; // Radix Slot pattern
}
```

### Implementation Tasks (Phased Approach)

## PHASE 0: Minimal Viable Package (Day 1)

### Task 0.1: Initialize Package Structure

**CREATE** `packages/ui/package.json`:

```json
{
  "name": "@mike/ui",
  "type": "module",
  "exports": {
    ".": "./src/index.ts",
    "./styles": "./src/tokens/index.css",
    "./tailwind": "./src/tailwind-preset.ts"
  },
  "scripts": {
    "dev": "tsup --watch",
    "build": "tsup",
    "typecheck": "tsc --noEmit"
  }
}
```

### Task 0.2: Core Utilities

**CREATE** `packages/ui/src/utils/cn.ts`:

```typescript
import { clsx, type ClassValue } from 'clsx'
import { twMerge } from 'tailwind-merge'

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
```

### Task 0.3: First Component - Button

**CREATE** `packages/ui/src/primitives/button/button.tsx`:

- Use CVA for variants
- No "use client" needed (server component)
- Export both component and variant helper

### Task 0.4: Wire to App

**MODIFY** `apps/web/package.json`:

- Add `"@mike/ui": "workspace:*"` to dependencies

**CREATE** `apps/web/app/test/page.tsx`:

- Import and render Button
- Verify build pipeline works end-to-end

### Task 0.5: Validate Phase 0

**RUN**: `pnpm --filter web dev`

**CHECK**: Button renders with styles applied

**FIX**: Any module resolution or build errors

## PHASE 1: Token System & Theme (Days 2-3)

### Task 1.1: Base Token Layer

CREATE packages/ui/src/tokens/base.css:

CSS reset (box-sizing, margin reset).

Font smoothing.

Focus-visible defaults.

CREATE packages/ui/src/tokens/colors.css:

:root {
  /* Base colors (HSL without wrapper) */
  --slate-50: 248 9% 97%;
  --slate-100: 241 8% 95%;
  /* ... full scale ... */

  --blue-500: 217 91% 60%;
  --blue-600: 221 83% 53%;
  /* ... other scales ... */
}

Task 1.2: Semantic Token Layer

CREATE packages/ui/src/tokens/semantic.css:

:root {
  /* Light theme (default) */
  --background: var(--slate-50);
  --foreground: var(--slate-900);
  --primary: var(--blue-600);
  --primary-foreground: var(--white);
  --muted: var(--slate-100);
  --muted-foreground: var(--slate-600);
  --border: var(--slate-200);
  --ring: var(--blue-500);

  /* Component-specific */
  --button-primary-hover: var(--blue-700);
}

[data-theme="dark"] {
  --background: var(--slate-950);
  --foreground: var(--slate-50);
  --primary: var(--blue-500);
  --border: var(--slate-800);
  /* ... rest of dark tokens ... */
}

Task 1.3: Tailwind Preset

CREATE packages/ui/src/tailwind-preset.ts:

export default {
  darkMode: ['class', '[data-theme="dark"]'],
  theme: {
    extend: {
      colors: {
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        // ... map all semantic tokens
      },
      keyframes: {
        'fade-in': { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
        'slide-up': {
          '0%': { transform: 'translateY(10px)', opacity: 0 },
          '100%': { transform: 'translateY(0)', opacity: 1 }
        },
      },
      animation: {
        'fade-in': 'fade-in 200ms ease-out',
        'slide-up': 'slide-up 300ms cubic-bezier(0.16, 1, 0.3, 1)',
      },
      zIndex: {
        dropdown: '50',
        overlay: '100',
        modal: '200',
        notification: '300',
        tooltip: '400',
      }
    }
  }
}

Task 1.4: Theme Provider

CREATE apps/web/components/theme-provider.tsx:

"use client".

useEffect to sync theme with localStorage.

Prevent flash with blocking script.

Export useTheme hook.

Task 1.5: Validate Phase 1

TEST: Toggle between light/dark themes.

CHECK: No flash on page refresh.

CHECK: All token values apply correctly.

PHASE 2: Core Form Primitives (Days 4-5)

Task 2.1: Input Component

CREATE packages/ui/src/primitives/input/input.tsx:

Server component (no state).

Variants: default, error.

Proper aria-invalid, aria-describedby.

Task 2.2: Label Component

CREATE packages/ui/src/primitives/label/label.tsx:

Proper htmlFor association.

Required indicator variant.

Task 2.3: Form Composition

CREATE packages/ui/src/compositions/form-row/form-row.tsx:

interface FormRowProps {
  label: string;
  error?: string;
  hint?: string;
  required?: boolean;
  children: React.ReactNode;
}

Auto-generate IDs for aria-describedby.

Error state styling.

Task 2.4: Tests for Forms

CREATE packages/ui/src/primitives/input/input.test.tsx:

Renders all variants.

Aria attributes present.

Keyboard navigation works.

PHASE 3: Storybook & Testing Setup (Days 6-7)

Task 3.1: Storybook Configuration

CREATE packages/ui/.storybook/main.ts:

export default {
  stories: ['../src/**/*.stories.tsx'],
  addons: [
    '@storybook/addon-essentials',
    '@storybook/addon-a11y',
    '@storybook/addon-themes',
  ],
  framework: {
    name: '@storybook/nextjs',
    options: {},
  },
}

Task 3.2: Preview Configuration

CREATE packages/ui/.storybook/preview.tsx:

Import token CSS.

Add theme switcher toolbar.

Global decorators for padding.

Task 3.3: Component Stories

CREATE packages/ui/src/primitives/button/button.stories.tsx:

All variants × all sizes matrix.

Loading states.

Disabled states.

With icons examples.

Task 3.4: Visual Testing Setup

CREATE packages/ui/playwright.config.ts:

Screenshot testing configuration.

Storybook integration.

CI-friendly settings.

Task 3.5: Accessibility Testing

ADD to all stories:

Axe addon checks.

Keyboard navigation scenarios.

Screen reader annotations.

PHASE 4: Interactive Primitives (Week 2)

Task 4.1: Dialog Component

CREATE packages/ui/src/primitives/dialog/:

"use client" required (state management).

Radix Dialog primitive.

Overlay with scroll lock.

Focus trap and restoration.

Animate in/out.

Task 4.2: Sheet/Drawer Component

CREATE packages/ui/src/primitives/sheet/:

Variant of Dialog with slide animation.

Positions: left, right, top, bottom.

Touch-friendly on mobile.

Task 4.3: Select Component

CREATE packages/ui/src/primitives/select/:

Radix Select primitive.

Custom trigger styling.

Searchable variant.

Multi-select variant.

Task 4.4: Toast System

CREATE packages/ui/src/primitives/toast/:

Global toast provider.

Zustand for state management.

Auto-dismiss with progress.

Variants: default, success, error, warning.

Task 4.5: Tooltip Component

CREATE packages/ui/src/primitives/tooltip/:

Radix Tooltip primitive.

Delay configuration.

Arrow positioning.

Touch device handling.

PHASE 5: Data Display Primitives (Week 2)

Task 5.1: Card Component

CREATE packages/ui/src/primitives/card/:

Header, body, footer slots.

Interactive variant with hover states.

Loading skeleton integration.

Task 5.2: Badge Component

CREATE packages/ui/src/primitives/badge/:

Variants: default, secondary, success, warning, error.

Sizes: sm, md.

Removable variant with × button.

Task 5.3: Skeleton Component

CREATE packages/ui/src/primitives/skeleton/:

Pulse animation.

Variants: text, rectangular, circular.

Composite patterns (card skeleton, list skeleton).

Task 5.4: Tabs Component

CREATE packages/ui/src/primitives/tabs/:

Radix Tabs primitive.

Horizontal/vertical orientation.

Keyboard navigation.

Lazy loading support.

PHASE 6: Patterns & Documentation (Week 3)

Task 6.1: Page Header Pattern

CREATE packages/ui/src/patterns/page-header/:

Title, description, actions slots.

Breadcrumb support.

Back button variant.

Task 6.2: Prose Pattern

CREATE packages/ui/src/patterns/prose/:

Typography for long-form content.

PortableText support.

MDX compatibility.

Code block styling.

Task 6.3: Empty State Pattern

CREATE packages/ui/src/patterns/empty-state/:

Icon, title, description.

Action buttons.

Illustration support.

Task 6.4: Component Documentation

CREATE packages/ui/README.md:

Installation instructions.

Theme customization.

Component API reference.

Migration guide.

Task 6.5: TypeDoc Generation

SETUP automated API docs:

JSDoc all exports.

Generate static docs site.

Deploy to GitHub Pages.

PHASE 7: Performance & Polish (Week 3)

Task 7.1: Bundle Analysis

SETUP size-limit:

Track component sizes.

Set budgets per component.

CI checks for regressions.

Task 7.2: Tree Shaking Validation

TEST selective imports:

Verify unused components excluded.

Check CSS purging works.

Optimize barrel exports.

Task 7.3: Performance Monitoring

ADD metrics collection:

Component render times.

Interaction responsiveness.

Memory usage patterns.

Task 7.4: Error Boundaries

CREATE error handling:

Component-level boundaries.

Fallback UI patterns.

Error reporting integration.

PHASE 8: CI/CD & Release (Week 3)

Task 8.1: CI Pipeline

CREATE .github/workflows/ui.yml:

Lint (ESLint + Prettier).

Type check.

Unit tests (>80% coverage).

Visual regression tests.

Bundle size checks.

Accessibility audit.

Task 8.2: Release Automation

SETUP changesets:

Semantic versioning.

Automated changelog.

NPM publishing (if needed).

Task 8.3: Deployment

SETUP documentation site:

Storybook deployment.

API docs deployment.

Version switcher.

### Per-Task Pseudocode & Critical Implementation Details

#### Task 0.3: Button Implementation (CRITICAL PATTERNS)

```typescript
import { cva, type VariantProps } from 'class-variance-authority'
import { cn } from '../../utils/cn'
import { forwardRef } from 'react'

const buttonVariants = cva(
  // Base styles (always applied)
  'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        outline: 'border border-border bg-background hover:bg-muted',
        ghost: 'hover:bg-muted hover:text-muted-foreground',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
      },
      size: {
        sm: 'h-8 px-3 text-xs',
        md: 'h-10 px-4',
        lg: 'h-11 px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'md',
    },
  })

// PATTERN: Always use forwardRef for primitives
export const Button = forwardRef<
  HTMLButtonElement,
  React.ButtonHTMLAttributes<HTMLButtonElement> &
  VariantProps<typeof buttonVariants> & {
    loading?: boolean;
    leftIcon?: React.ReactNode;
    rightIcon?: React.ReactNode;
  }
>(({ className, variant, size, loading, leftIcon, rightIcon, children, disabled, ...props }, ref) => {
  return (
    <button
      ref={ref}
      className={cn(buttonVariants({ variant, size, className }))}
      disabled={disabled || loading}
      {...props}
    >
      {/* PATTERN: Conditional rendering for loading state */}
      {loading ? (
        <>
          <Spinner className="mr-2 h-4 w-4 animate-spin" />
          {children}
        </>
      ) : (
        <>
          {leftIcon && <span className="mr-2">{leftIcon}</span>}
          {children}
          {rightIcon && <span className="ml-2">{rightIcon}</span>}
        </>
      )}
    </button>
  )
})
Button.displayName = 'Button'

// Export variant helper for compound components
export { buttonVariants }
```

#### Task 1.4: Theme Provider Implementation

```typescript
'use client'
import { createContext, useContext, useEffect, useState } from 'react'

type Theme = 'light' | 'dark' | 'system'

const ThemeContext = createContext<{
  theme: Theme
  setTheme: (theme: Theme) => void
}>({
  theme: 'system',
  setTheme: () => null,
})

export function ThemeProvider({ children }: { children: React.ReactNode }) {
  const [theme, setTheme] = useState<Theme>('system')
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    // CRITICAL: Read from localStorage after mount to avoid hydration mismatch
    const stored = localStorage.getItem('theme') as Theme
    if (stored) setTheme(stored)
    setMounted(true)
  }, [])

  useEffect(() => {
    if (!mounted) return
    const root = document.documentElement
    const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    const activeTheme = theme === 'system' ? systemTheme : theme

    // PATTERN: Use data attribute for theme (works with SSR)
    root.dataset.theme = activeTheme
    
    // CRITICAL: Also set class for Tailwind dark mode
    root.classList.toggle('dark', activeTheme === 'dark')
    
    // Persist choice
    localStorage.setItem('theme', theme)
  }, [theme, mounted])

  // CRITICAL: Listen for system theme changes
  useEffect(() => {
    if (theme !== 'system') return
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    const handleChange = () => {
      const systemTheme = mediaQuery.matches ? 'dark' : 'light'
      document.documentElement.dataset.theme = systemTheme
      document.documentElement.classList.toggle('dark', systemTheme === 'dark')
    }
    mediaQuery.addEventListener('change', handleChange)
    return () => mediaQuery.removeEventListener('change', handleChange)
  }, [theme])

  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  )
}

export const useTheme = () => {
  const context = useContext(ThemeContext)
  if (!context) throw new Error('useTheme must be used within ThemeProvider')
  return context
}
```

#### Task 4.1: Dialog Implementation (with Radix)

```typescript
'use client'
import * as DialogPrimitive from '@radix-ui/react-dialog'
import { cn } from '../../utils/cn'
import { forwardRef } from 'react'
import { X } from 'lucide-react'

export const Dialog = DialogPrimitive.Root
export const DialogTrigger = DialogPrimitive.Trigger
export const DialogPortal = DialogPrimitive.Portal

// PATTERN: Overlay with animation
export const DialogOverlay = forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      'fixed inset-0 z-overlay bg-background/80 backdrop-blur-sm',
      'data-[state=open]:animate-fade-in data-[state=closed]:animate-fade-out',
      className
    )}
    {...props}
  />
))

// PATTERN: Content with focus trap and animations
export const DialogContent = forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        'fixed left-1/2 top-1/2 z-modal w-full max-w-lg',
        '-translate-x-1/2 -translate-y-1/2',
        'rounded-lg bg-background p-6 shadow-lg',
        'data-[state=open]:animate-slide-up',
        'focus:outline-none',
        className
      )}
      {...props}
    >
      {children}
      {/* CRITICAL: Close button for accessibility */}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 hover:opacity-100">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
```
```typescript
// Task 4.4: Toast System with Zustand (continued)
import { create } from 'zustand'
import { nanoid } from 'nanoid'

interface Toast {
  id: string
  title: string
  description?: string
  variant?: 'default' | 'success' | 'error' | 'warning'
  duration?: number
}

interface ToastStore {
  toasts: Toast[]
  addToast: (toast: Omit<Toast, 'id'>) => void
  removeToast: (id: string) => void
  clearToasts: () => void
}

export const useToastStore = create<ToastStore>((set) => ({
  toasts: [],
  addToast: (toast) => {
    const id = nanoid()
    const newToast = { ...toast, id }

    set((state) => ({
      toasts: [...state.toasts, newToast]
    }))

    // Auto-dismiss after duration (default 5s)
    const duration = toast.duration ?? 5000
    if (duration > 0) {
      setTimeout(() => {
        set((state) => ({
          toasts: state.toasts.filter((t) => t.id !== id)
        }))
      }, duration)
    }
  },
  removeToast: (id) => set((state) => ({
    toasts: state.toasts.filter((t) => t.id !== id)
  })),
  clearToasts: () => set({ toasts: [] })
}))

// Toast hook for easier usage
export function useToast() {
  const { addToast, removeToast } = useToastStore()
  return {
    toast: addToast,
    dismiss: removeToast,
    // Convenience methods
    success: (title: string, description?: string) =>
      addToast({ title, description, variant: 'success' }),
    error: (title: string, description?: string) =>
      addToast({ title, description, variant: 'error' }),
    warning: (title: string, description?: string) =>
      addToast({ title, description, variant: 'warning' }),
  }
}

### Integration Points

#### Configuration

**apps/web/tailwind.config.ts:**

```typescript
import uiPreset from '@mike/ui/tailwind'
export default {
  presets: [uiPreset],
  content: [
    './app/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    '../../packages/ui/src/**/*.{ts,tsx}', // Include UI package
  ],
}
```

**apps/web/app/globals.css:**

```css
@import '@mike/ui/styles';
@tailwind base;
@tailwind components;
@tailwind utilities;
```

**apps/web/app/layout.tsx:**

```tsx
import { ThemeProvider } from '@/components/theme-provider'

export default function RootLayout({ children }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        {/* Prevent flash */}
        <script dangerouslySetInnerHTML={{
          __html: `(function(){try{const t=localStorage.getItem('theme')||'light';
          document.documentElement.dataset.theme=t;
          document.documentElement.classList.toggle('dark',t==='dark')}catch{}})()`,
        }} />
      </head>
      <body>
        <ThemeProvider>{children}</ThemeProvider>
      </body>
    </html>
  )
}
```
#### Environment Variables

**Development:**
- `NODE_ENV: development`
- `STORYBOOK_URL: http://localhost:6006`

**CI/Testing:**
- `NODE_ENV: test`
- `CI: true`

**Production:**
- `NODE_ENV: production`
- `ANALYZE_BUNDLE: true` (optional)

#### TypeScript Configuration

**packages/ui/tsconfig.json:**

```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "composite": true,
    "declaration": true,
    "declarationMap": true,
    "rootDir": "./src",
    "outDir": "./dist"
  },
  "include": ["src/**/*"],
  "references": []
}
```
#### Analytics Hooks

Components expose data attributes:

```tsx
<Button data-track="cta-click" data-track-label={label}>
```

Note: No analytics code in UI package

#### Accessibility

ESLint configuration:

```json
{
  "extends": ["plugin:jsx-a11y/recommended"],
  "rules": {
    "jsx-a11y/anchor-is-valid": "error",
    "jsx-a11y/aria-props": "error",
    "jsx-a11y/aria-role": "error"
  }
}
```

#### Versioning

**.changeset/config.json:**

```json
{
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "linked": [],
  "access": "public",
  "baseBranch": "main"
}
```

---

### Level 1: Syntax & Style (Run after each task)

```bash
# Lint check (auto-fix when possible)
pnpm --filter @mike/ui lint --fix
pnpm --filter web lint --fix
# Type checking
pnpm --filter @mike/ui typecheck
pnpm --filter web typecheck
# Format check
pnpm prettier --write "packages/ui/**/*.{ts,tsx,css}"
# Component size check
node scripts/check-component-size.js packages/ui/src
# Expected: All green. Fix any errors before proceeding.
```

### Level 2: Unit & Component Tests

Example test structure for each component:

**packages/ui/src/primitives/button/button.test.tsx:**

```typescript
import { render, screen, userEvent } from '@testing-library/react'
import { axe, toHaveNoViolations } from 'jest-axe'
import { Button, buttonVariants } from './button'

expect.extend(toHaveNoViolations)

describe('Button', () => {
  // Rendering tests
  it('renders with text', () => {
    render(<Button>Click me</Button>)
    expect(screen.getByRole('button')).toHaveTextContent('Click me')
  })

  // Variant tests
  describe('variants', () => {
    it.each(['default', 'secondary', 'outline', 'ghost', 'destructive'])
      ('renders %s variant', (variant) => {
        render(<Button variant={variant}>Test</Button>)
        const button = screen.getByRole('button')
        expect(button).toHaveClass(buttonVariants({ variant }))
      })
  })

  // Interaction tests
  it('handles click events', async () => {
    const handleClick = jest.fn()
    render(<Button onClick={handleClick}>Click</Button>)

    await userEvent.click(screen.getByRole('button'))
    expect(handleClick).toHaveBeenCalledTimes(1)
  })

  // State tests
  it('disables when loading', () => {
    render(<Button loading>Loading</Button>)
    expect(screen.getByRole('button')).toBeDisabled()
  })

  // Accessibility tests
  it('has no accessibility violations', async () => {
    const { container } = render(
      <Button>Accessible button</Button>
    )
    const results = await axe(container)
    expect(results).toHaveNoViolations()
  })

  // Keyboard navigation
  it('supports keyboard activation', async () => {
    const handleClick = jest.fn()
    render(<Button onClick={handleClick}>Press Enter</Button>)

    const button = screen.getByRole('button')
    button.focus()
    await userEvent.keyboard('{Enter}')
    expect(handleClick).toHaveBeenCalled()
  })
})
```

**Run tests:**

```bash
# Run tests with coverage
pnpm --filter @mike/ui test --coverage
# Watch mode for development
pnpm --filter @mike/ui test --watch
# Expected: >80% coverage, all tests passing
```

### Level 3: Visual Testing

**packages/ui/playwright.config.ts:**

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './src',
  testMatch: '**/*.visual.test.ts',
  use: {
    baseURL: 'http://localhost:6006',
    screenshot: {
      mode: 'only-on-failure',
      fullPage: true,
    },
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'mobile',
      use: { ...devices['iPhone 12'] },
    },
  ],
})
```

**Example visual test:**

**packages/ui/src/primitives/button/button.visual.test.ts:**

```typescript
import { test, expect } from '@playwright/test'

test.describe('Button Visual Tests', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/story/primitives-button--default')
  })

  test('should match screenshot', async ({ page }) => {
    await expect(page).toHaveScreenshot('button-default.png')
  })
})
```