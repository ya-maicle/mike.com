## 2026-02-12T23:18:00Z - PW-004
- **Task**: Ensure preview-to-main pipeline also has CI checks and smoke tests.
- **Outcome**: Updated the `.github/workflows/pr.yml` file to run on PRs to both `preview` and `main`. Added a condition to the `smoke-test` job to run the appropriate test file based on the target branch.
- **Files Changed**:
  - `.github/workflows/pr.yml`
- **Learnings for future iterations:**
  - Using a conditional in the workflow file is a simple way to run different tests for different branches.
---
## 2026-02-12T23:16:00Z - PW-003
- **Task**: Add Playwright to CI workflow with Vercel preview URL.
- **Outcome**: Added a new `smoke-test` job to the `.github/workflows/pr.yml` file. This job uses the `patrickedqvist/wait-for-vercel-preview` action to get the Vercel preview URL and then runs the Playwright smoke tests.
- **Files Changed**:
  - `.github/workflows/pr.yml`
- **Learnings for future iterations:**
  - The `patrickedqvist/wait-for-vercel-preview` action is a simple way to get the Vercel preview URL in a GitHub Actions workflow.
  - It's important to pass the `VERCEL_TOKEN` and `VERCEL_AUTOMATION_BYPASS_SECRET` secrets to the workflow for it to work correctly.
---
## 2026-02-12T23:14:00Z - PW-002
- **Task**: Update smoke tests to match current site content.
- **Outcome**: Updated `tests/smoke/preview.spec.ts` to check for actual page content, and created the `/api/health` endpoint.
- **Files Changed**:
  - `tests/smoke/preview.spec.ts`
  - `apps/web/src/app/api/health/route.ts`
- **Learnings for future iterations:**
  - The `production.spec.ts` was already resilient and did not need to be updated.
  - It's important to keep smoke tests up-to-date with the actual content of the site.
---
## 2026-02-12T23:04:18Z - PW-001
- **Task**: Investigate test failures and Vercel CI integration gap.
- **Outcome**: Completed investigation and documented findings.
- **Files Analyzed**:
  - `playwright.config.ts`
  - `tests/smoke/preview.spec.ts`
  - `tests/smoke/production.spec.ts`
  - `.github/workflows/pr.yml`
  - `apps/web/src/app/(website)/page.tsx`
  - `apps/web/src/app/api/health/route.ts`

- **Learnings for future iterations:**
  - **Stale Assertions**: `tests/smoke/preview.spec.ts` contains assertions based on the default Next.js starter page (e.g., "Get started by editing"). These are completely outdated. The current homepage (`apps/web/src/app/(website)/page.tsx`) is built with Sanity and has a different structure (e.g., `<h1>` with a tagline).
  - **Actual Page Content**: The homepage renders a `main` element, a `h1` tagline, a `p` subtitle, and potentially hero buttons. Tests should be updated to check for these resilient elements instead of specific text.
  - **CI Gap**: The `.github/workflows/pr.yml` file has jobs for type checking, linting, and building, but it does **not** have a job to run the Playwright smoke tests. This is a major gap.
  - **Missing Health API**: The file `apps/web/src/app/api/health/route.ts` was not found, meaning the `/api/health` check in `preview.spec.ts` will fail. This route needs to be created.
  - **Required Environment Variables**: For Playwright tests to run (especially in CI), two environment variables are essential:
    - `PLAYWRIGHT_BASE_URL`: The URL of the environment to test (e.g., the Vercel preview deployment URL).
    - `VERCEL_AUTOMATION_BYPASS_SECRET`: The secret to bypass Vercel's deployment protection.
  - **Getting the Vercel Preview URL**: Research indicates several methods to retrieve the Vercel preview URL in a GitHub Actions workflow:
    - **Vercel CLI**: Use `vercel deploy` and parse the output to get the URL. This requires storing `VERCEL_TOKEN`, `VERCEL_ORG_ID`, and `VERCEL_PROJECT_ID` as GitHub secrets.
    - **GitHub Actions**: Actions like `patrickedqvist/wait-for-vercel-preview` or `amondnet/vercel-action` are designed to wait for the Vercel deployment to finish and return its URL. This seems like a simpler and more robust approach.
    - **GitHub Deployment API**: Vercel creates a GitHub "deployment" event. The workflow could listen for this event or query the API to get the deployment URL.
---
# Ralph Progress Log
Started: Thu Feb 12 23:04:18 GMT 2026
---
